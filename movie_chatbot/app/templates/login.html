{% extends "base.html" %}

{% block content %}
<div class="login-container">
    <h1>Admin Login</h1>
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
    <form id="loginForm">
        <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" required>
        </div>
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required>
        </div>
        <button type="submit" class="btn btn-primary">Login</button>
    </form>
</div>

<script src="{{ url_for('static', path='/js/auth.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('loginForm');
        if (!form) return;
        
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.textContent;
            
            try {
                // Disable button and show loading state
                submitBtn.disabled = true;
                submitBtn.textContent = 'Logging in...';
                
                const response = await fetch('/token', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'username': username,
                        'password': password,
                    }),
                    credentials: 'include'  // Important for cookies to be sent/received
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Store token in localStorage as fallback
                    localStorage.setItem('access_token', data.access_token);
                    
                    // Redirect to admin page
                    window.location.href = '/admin';
                } else {
                    const errorData = await response.json().catch(() => ({
                        detail: 'Login failed. Please check your credentials.'
                    }));
                    // Reload the page with error message
                    window.location.href = `/login?error=${encodeURIComponent(errorData.detail)}`;
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('An error occurred during login. Please try again.');
            }
        });
    });
</script>
{% endblock %}