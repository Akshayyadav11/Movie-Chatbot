{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>User Management</h3>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal" id="addUserBtn">
                        <i class="fas fa-plus"></i> Add New User
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Admin</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <!-- Users will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="userModal" tabindex="-1" role="dialog" style="display: none;" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="isActive" name="is_active" checked>
                            <label class="form-check-label" for="isActive">Active</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="isAdmin" name="is_admin">
                            <label class="form-check-label" for="isAdmin">Admin</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">Save</button>
            </div>
        </div>
    </div>
</div>

<style>
/* User Management Styles */
.status-badge {
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.85rem;
}

.status-active {
    background-color: #28a745;
    color: white;
}

.status-inactive {
    background-color: #dc3545;
    color: white;
}

.admin-badge {
    background-color: #007bff;
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.85rem;
}

.action-btn {
    margin-right: 5px;
}
</style>

<script>
let userIdToEdit = null;

// Check if user is authenticated and is admin
async function checkAuth() {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/admin/login';
        return false;
    }
    return true;
}

// Load users when page loads
document.addEventListener('DOMContentLoaded', async () => {
    if (await checkAuth()) {
        loadUsers();
        
        // Get the modal element
        const userModalEl = document.getElementById('userModal');
        
        // Initialize the modal with JavaScript
        if (userModalEl) {
            // Hide the modal initially
            userModalEl.style.display = 'none';
            userModalEl.classList.remove('show');
            
            // Add an event listener for when the modal is about to be shown
            userModalEl.addEventListener('show.bs.modal', function () {
                // Initialize the form when the modal is shown
                userIdToEdit = null;
                const form = document.getElementById('userForm');
                if (form) form.reset();
                
                const isActive = document.getElementById('isActive');
                if (isActive) isActive.checked = true;
                
                const isAdmin = document.getElementById('isAdmin');
                if (isAdmin) isAdmin.checked = false;
                
                const modalTitle = document.querySelector('.modal-title');
                if (modalTitle) modalTitle.textContent = 'Add New User';
                
                // Ensure modal is visible
                userModalEl.style.display = 'block';
                userModalEl.classList.add('show');
            });
            
            // Handle modal hide event
            userModalEl.addEventListener('hidden.bs.modal', function () {
                userModalEl.style.display = 'none';
                userModalEl.classList.remove('show');
            });
        }
    }
});

// Load users from API
async function loadUsers() {
    const token = localStorage.getItem('token');
    try {
        const response = await fetch('/api/users', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.status === 401) {
            // Token expired or invalid
            localStorage.removeItem('token');
            window.location.href = '/admin/login';
            return;
        }
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to load users');
        }
        
        const users = await response.json();
        renderUsers(users);
    } catch (error) {
        console.error('Error loading users:', error);
        alert(`Error: ${error.message}`);
    }
}

// Render users in table
function renderUsers(users) {
    const tbody = document.getElementById('usersTable');
    tbody.innerHTML = '';
    
    users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${user.username}</td>
            <td>${user.email || 'N/A'}</td>
            <td>
                <span class="status-badge ${user.is_active ? 'status-active' : 'status-inactive'}">
                    ${user.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                ${user.is_admin ? '<span class="admin-badge">Admin</span>' : ''}
            </td>
            <td>
                <button class="btn btn-sm btn-primary action-btn" onclick="editUser(${user.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm ${user.is_active ? 'btn-danger' : 'btn-success'} action-btn" 
                        onclick="toggleStatus(${user.id}, ${!user.is_active})">
                    <i class="fas fa-${user.is_active ? 'ban' : 'check'}"></i>
                </button>
                <button class="btn btn-sm btn-danger action-btn" onclick="deleteUser(${user.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Open add user modal
function openAddUserModal() {
    userIdToEdit = null;
    const form = document.getElementById('userForm');
    if (form) form.reset();
    
    const isActive = document.getElementById('isActive');
    if (isActive) isActive.checked = true;
    
    const isAdmin = document.getElementById('isAdmin');
    if (isAdmin) isAdmin.checked = false;
    
    const modalTitle = document.querySelector('.modal-title');
    if (modalTitle) modalTitle.textContent = 'Add New User';
    
    // Initialize and show the modal using Bootstrap 5
    const userModal = new bootstrap.Modal(document.getElementById('userModal'));
    userModal.show();
}

// Open edit user modal
async function editUser(userId) {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/users/${userId}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.status === 401) {
            localStorage.removeItem('token');
            window.location.href = '/admin/login';
            return;
        }
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to load user');
        }
        
        const user = await response.json();
        userIdToEdit = userId;
        document.getElementById('username').value = user.username;
        document.getElementById('email').value = user.email;
        document.getElementById('isActive').checked = user.is_active;
        document.getElementById('isAdmin').checked = user.is_admin;
        document.querySelector('.modal-title').textContent = 'Edit User';
        $('#userModal').modal('show');
    } catch (error) {
        console.error('Error loading user:', error);
        alert(`Error: ${error.message}`);
    }
}

// Save user (add or update)
async function saveUser() {
    try {
        const token = localStorage.getItem('token');
        const form = document.getElementById('userForm');
        const formData = new FormData(form);
        
        // Convert FormData to plain object
        const userData = {
            username: formData.get('username'),
            email: formData.get('email'),
            password: formData.get('password'),
            is_active: document.getElementById('isActive').checked,
            is_admin: document.getElementById('isAdmin').checked
        };
        
        const response = await fetch(
            userIdToEdit ? `/api/users/${userIdToEdit}` : '/api/users',
            {
                method: userIdToEdit ? 'PUT' : 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            }
        );
        
        if (response.status === 401) {
            localStorage.removeItem('token');
            window.location.href = '/admin/login';
            return;
        }
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to save user');
        }
        
        $('#userModal').modal('hide');
        loadUsers();
        alert('User saved successfully');
    } catch (error) {
        console.error('Error saving user:', error);
        alert(`Error: ${error.message}`);
    }
}

// Toggle user status
async function toggleStatus(userId, newStatus) {
    if (!confirm(`Are you sure you want to ${newStatus ? 'activate' : 'deactivate'} this user?`)) {
        return;
    }
    
    const token = localStorage.getItem('token');
    try {
        const response = await fetch(`/api/users/${userId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ is_active: newStatus })
        });

        if (response.status === 401) {
            localStorage.removeItem('token');
            window.location.href = '/admin/login';
            return;
        }

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to update user status');
        }

        loadUsers();
    } catch (error) {
        console.error('Error:', error);
        alert(`Error: ${error.message}`);
    }
}

// Delete user
async function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user?')) {
        return;
    }

    const token = localStorage.getItem('token');
    try {
        const response = await fetch(`/api/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.status === 401) {
            localStorage.removeItem('token');
            window.location.href = '/admin/login';
            return;
        }

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to delete user');
        }

        loadUsers();
    } catch (error) {
        console.error('Error:', error);
        alert(`Error: ${error.message}`);
        alert('Failed to delete user');
    }
}
</script>
{% endblock %}
